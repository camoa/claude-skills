<?xml version="1.0" encoding="UTF-8"?>
<!--
  PHPMD ruleset for Drupal custom modules
  Copy to project root as phpmd.xml

  Usage:
    ddev exec vendor/bin/phpmd web/modules/custom text phpmd.xml

  Required package:
    composer require --dev phpmd/phpmd
-->
<ruleset name="Drupal Custom Modules"
         xmlns="http://pmd.sf.net/ruleset/1.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sf.net/ruleset/1.0.0 http://pmd.sf.net/ruleset_xml_schema.xsd"
         xsi:noNamespaceSchemaLocation="http://pmd.sf.net/ruleset_xml_schema.xsd">

    <description>
        PHPMD ruleset optimized for Drupal development with SOLID principle detection.
    </description>

    <!-- ===================== -->
    <!-- Clean Code Rules      -->
    <!-- ===================== -->
    <rule ref="rulesets/cleancode.xml">
        <!-- Allow static access to Drupal's service methods (use sparingly) -->
        <exclude name="StaticAccess"/>
    </rule>

    <!-- Re-enable StaticAccess with exceptions for common Drupal patterns -->
    <rule ref="rulesets/cleancode.xml/StaticAccess">
        <properties>
            <property name="exceptions">
                <value>
                    \Drupal\Core\StringTranslation\TranslatableMarkup,
                    \Drupal\Core\Render\Markup
                </value>
            </property>
        </properties>
    </rule>

    <!-- ===================== -->
    <!-- Code Size Rules (SRP) -->
    <!-- ===================== -->
    <rule ref="rulesets/codesize.xml/CyclomaticComplexity">
        <properties>
            <!-- Warn at 10, report at 15 -->
            <property name="reportLevel" value="10"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/NPathComplexity">
        <properties>
            <!-- Default 200, Drupal forms can be complex -->
            <property name="minimum" value="250"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/ExcessiveMethodLength">
        <properties>
            <!-- Methods over 50 lines need review -->
            <property name="minimum" value="50"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/ExcessiveClassLength">
        <properties>
            <!-- Classes over 500 lines need splitting -->
            <property name="minimum" value="500"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/ExcessiveParameterList">
        <properties>
            <!-- More than 5 params suggests object needed -->
            <property name="minimum" value="5"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/ExcessivePublicCount">
        <properties>
            <!-- Too many public methods indicates SRP violation -->
            <property name="minimum" value="20"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/TooManyFields">
        <properties>
            <!-- Many fields often means class does too much -->
            <property name="maxfields" value="15"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/TooManyMethods">
        <properties>
            <!-- Over 25 methods usually indicates SRP violation -->
            <property name="maxmethods" value="25"/>
            <!-- Ignore getters/setters -->
            <property name="ignorepattern" value="(^(set|get|is|has))i"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/TooManyPublicMethods">
        <properties>
            <property name="maxmethods" value="15"/>
            <property name="ignorepattern" value="(^(set|get|is|has))i"/>
        </properties>
    </rule>

    <rule ref="rulesets/codesize.xml/ExcessiveClassComplexity">
        <properties>
            <!-- Weighted method count threshold -->
            <property name="maximum" value="50"/>
        </properties>
    </rule>

    <!-- ===================== -->
    <!-- Design Rules          -->
    <!-- ===================== -->
    <rule ref="rulesets/design.xml">
        <!-- Drupal uses exit() in some legitimate cases -->
        <exclude name="ExitExpression"/>
    </rule>

    <rule ref="rulesets/design.xml/CouplingBetweenObjects">
        <properties>
            <!-- Services often have many dependencies -->
            <property name="maximum" value="15"/>
        </properties>
    </rule>

    <rule ref="rulesets/design.xml/DepthOfInheritance">
        <properties>
            <!-- Drupal plugin hierarchy can be deep -->
            <property name="minimum" value="6"/>
        </properties>
    </rule>

    <!-- ===================== -->
    <!-- Naming Rules          -->
    <!-- ===================== -->
    <rule ref="rulesets/naming.xml">
        <!-- Drupal allows short variable names in some contexts -->
        <exclude name="ShortVariable"/>
    </rule>

    <!-- Re-enable with Drupal-appropriate exceptions -->
    <rule ref="rulesets/naming.xml/ShortVariable">
        <properties>
            <property name="minimum" value="3"/>
            <property name="exceptions">
                <value>id,db,em,io,e,i,j,k,t</value>
            </property>
        </properties>
    </rule>

    <rule ref="rulesets/naming.xml/LongVariable">
        <properties>
            <!-- Drupal naming can be verbose -->
            <property name="maximum" value="30"/>
        </properties>
    </rule>

    <!-- ===================== -->
    <!-- Unused Code Rules     -->
    <!-- ===================== -->
    <rule ref="rulesets/unusedcode.xml">
        <!-- Drupal hooks may have unused parameters -->
        <exclude name="UnusedFormalParameter"/>
    </rule>

    <!-- Re-enable with hook awareness -->
    <rule ref="rulesets/unusedcode.xml/UnusedFormalParameter">
        <properties>
            <!-- Allow unused params in hook implementations -->
            <property name="ignorepattern" value="(^hook_|_alter$|_form$)"/>
        </properties>
    </rule>

</ruleset>
